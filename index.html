<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<script src="jquery-3.3.1.min.js"></script>
		<title>Ethereal Channel Viewer</title>
		<style>
html           { height: 100%; }
body           { height: 100%; margin: 0; background-color: #F1F1F1; font-family: Helvetica, Arial, sans-serif; color: #262626; }
a              { text-decoration: none; }
p              { margin: 0; }
.inline-block  { display: inline-block; }
.table         { display: table; width: 100%; }
.row           { display: table-row; }
.cell          { display: table-cell; vertical-align: middle; }
.content-table { display: inline-table; vertical-align: middle; }
.title         { font-weight: bold; }
#page-table    { display: table; height: 100%; text-align: center; }
#total-cell    { display: table-cell; height: 100%; vertical-align: middle; }
		</style>
	</head>
	<body onload="AssignButtons();">
<!-- PAGE -->
		<div id="page-table">
<!-- CONTENT -->
			<div id="total-cell">
<!-- USER MOD -->
				<div class="content-table">
					<div class="inline-block, title" id="current-user">No User Loaded</div>
					<div class="inline-block"><input type="text" id="input-user" /><input type="button" value="Load User" id="button-user" onclick="LoadUser(document.getElementById('input-user').value);" /></div>
				</div>
<!-- CHANNEL MOD -->
				<div class="content-table">
					<div class="inline-block, title" id="current-channel">No Channel Loaded</div>
					<div class="inline-block">
						<input type="text" id="input-channel-twitch" />
						<input type="button" value="Load Twitch Channel" id="button-channel-twitch" onclick="LoadChannel(document.getElementById('input-channel-twitch').value, 'twitch');" />
						<input type="text" id="input-channel-mixer" />
						<input type="button" value="Load Mixer Channel" id="button-channel-mixer" onclick="LoadChannel(document.getElementById('input-channel-mixer').value, 'mixer');" />
					</div>
				</div>
<!-- FOLLOWS & CHANNEL & CHAT -->
				<div class="content-table">
					<div class="row">
<!-- FOLLOWS -->
						<div class="cell">
							<p class="title"><span onclick="UpdateFollowListHelix();">twitch (click to update)</span></p>
							<div id="follows-helix"></div>
							<p class="title"><span onclick="UpdateFollowListMixer();">mixer (click to update)</span></p>
							<div id="follows-mixer"></div>
						</div>
<!-- CHANNEL -->
						<div class="cell">
							<iframe id="frame-player" src="https://player.twitch.tv/?channel=" frameborder="0" allowfullscreen="true" scrolling="no" width="1280" height="720"></iframe>
						</div>
<!-- CHAT -->
						<div class="cell">
							<iframe id="frame-chat" src="about:blank" frameborder="0" scrolling="no" width="340" height="720"></iframe>
						</div>

					</div>
				</div>

			</div>
		</div>
		<script>
var g_userName;
var isFirstId;
var oldTableT, oldTableM;
var countHelix, countMixer;
var pageHelix, pageMixer;
var urlUsersTwitch, urlStreamsTwitch;
var dataUserTwitch, dataFollowsTwitch, dataUsersTwitch, dataStreamsTwitch;
var dataUserMixer, dataFollowsMixer;
var userObjT = {};
var userIndexTwitch, userIndexMixer;
var hasCountTwitch, hasCountMixer;
var tableT, rowT, cellT, pT, spanT;
var tableM, rowM, cellM, pM, spanM;
var ii, jj;

function AssignButtons() {
	var element;
	element = document.getElementById("input-channel-twitch");
	element.addEventListener("keyup", function(event) {
		//event.preventDefault();
		if (event.keyCode == 13) {
			document.getElementById("button-channel-twitch").click();
		}
	}, {passive: true});
	element = document.getElementById("input-channel-mixer");
	element.addEventListener("keyup", function(event) {
		//event.preventDefault();
		if (event.keyCode == 13) {
			document.getElementById("button-channel-mixer").click();
		}
	}, {passive: true});
	element = document.getElementById("input-user");
	element.addEventListener("keyup", function(event) {
		//event.preventDefault();
		if (event.keyCode == 13) {
			document.getElementById("button-user").click();
		}
	}, {passive: true});
}

function LoadChannel(channelName, service) {
	if (channelName == "") {
		document.getElementById("current-channel").innerHTML = "No Channel Loaded";
		document.getElementById("frame-player").setAttribute("src", "about:blank");
		document.getElementById("frame-chat").setAttribute("src", "about:blank");
	} else {
		document.getElementById("current-channel").innerHTML = channelName;
		if (service == "twitch") {
			document.getElementById("frame-player").setAttribute("src", "https://player.twitch.tv/?channel="+channelName+"&muted=false");
			document.getElementById("frame-chat").setAttribute("src", "https://www.twitch.tv/embed/"+channelName+"/chat");
			document.getElementById("frame-chat").setAttribute("width", "340");
		} else {
			document.getElementById("frame-player").setAttribute("src", "https://mixer.com/embed/player/"+channelName);
			document.getElementById("frame-chat").setAttribute("src", "https://mixer.com/embed/chat/"+channelName);
			document.getElementById("frame-chat").setAttribute("width", "378");
		}
	}
}

function LoadUser(userName) {
	if (userName == "") {
		document.getElementById("current-user").innerHTML = "No User Loaded";
		oldTableT = document.getElementById("follow-table-helix");
		if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
		oldTableM = document.getElementById("follow-table-mixer");
		if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
	} else {
		document.getElementById("current-user").innerHTML = userName;
		oldTableT = document.getElementById("follow-table-helix");
		if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
		oldTableM = document.getElementById("follow-table-mixer");
		if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
		g_userName = userName;
		CreateFollowListHelix();
		CreateFollowListMixer();
	}
}

function CreateFollowListHelix() {
	$.ajax({
		type: "GET",
		url: "https://api.twitch.tv/helix/users?login=" + g_userName,
		headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
		success: function(data) {
			//console.log(data);
			dataUserTwitch = data;
			GetFollowsHelix(true, false);
		}
	});
}

function GetFollowsHelix(init, destroy) {
	if (init) {
		userIndexTwitch = 0;
		hasCountTwitch = false;
		pageHelix = "";
		if (!destroy) {
			tableT = document.createElement("div");
			tableT.classList.add("table");
			tableT.setAttribute("id", "follow-table-helix");
			document.getElementById("follows-helix").appendChild(tableT);
		}
	}

	if (destroy) {
		oldTableT = document.getElementById("follow-table-helix");
		if (oldTableT) oldTableT.parentNode.removeChild(oldTableT);
		tableT = document.createElement("div");
		tableT.classList.add("table");
		tableT.setAttribute("id", "follow-table-helix");
		document.getElementById("follows-helix").appendChild(tableT);
	}

	$.ajax({
		type: "GET",
		url: "https://api.twitch.tv/helix/users/follows?from_id=" + dataUserTwitch.data[0].id + "&first=100&after=" + pageHelix,
		headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
		success: function(data) {
			//console.log(data);
			dataFollowsTwitch = data;
			if (!hasCountTwitch) {
				countHelix = parseInt(data.total);
				countHelix -= data.data.length;
				hasCountTwitch = true;
			} else {
				countHelix -= data.data.length;
			}
			pageHelix = data.pagination.cursor;
			isFirstId = true;
			urlUsersTwitch = "https://api.twitch.tv/helix/users";
			urlStreamsTwitch = "https://api.twitch.tv/helix/streams";
			userObjT.user = [];
			for (ii = 0 ; ii < data.data.length ; ii++) {
				userObjT.user[ii] = { id: "", login: "" };
				userObjT.user[ii].id = data.data[ii].to_id;

				// create complete URL for all-in-one name request
				if (isFirstId) { // with first id add ? instead of &
					urlUsersTwitch = urlUsersTwitch + "?id=" + data.data[ii].to_id;
					urlStreamsTwitch = urlStreamsTwitch + "?user_id=" + data.data[ii].to_id;
					isFirstId = false;
				} else {
					urlUsersTwitch = urlUsersTwitch + "&id=" + data.data[ii].to_id;
					urlStreamsTwitch = urlStreamsTwitch + "&user_id=" + data.data[ii].to_id;
				}
			}
		},
		complete: function() {
			return GetUsersHelix();
		}
	});
}

function GetUsersHelix() {
	$.ajax({
		type: "GET",
		url: urlUsersTwitch,
		headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
		success: function(data) {
			//console.log(data);
			dataUsersTwitch = data;
			for (ii = 0 ; ii < data.data.length ; ii++) {
				for (jj = 0 ; jj < dataFollowsTwitch.data.length ; jj++) {
					if (userObjT.user[jj].id == data.data[ii].id) {
						userObjT.user[jj].login = data.data[ii].login;
					}
				}
			}
		},
		complete: function() {
			return GetStreamsHelix();
		}
	});
}

function GetStreamsHelix() {
	$.ajax({
		type: "GET",
		url: urlStreamsTwitch,
		headers: { "Client-ID": "88pfy9ckfkxt3mp678i4ar9b0tr2q6" },
		success: function(data) {
			//console.log(data);
			dataStreamsTwitch = data;
		},
		complete: function() {
			$.when(AfterGetsHelix()).done( function() {
				if (countHelix > 0 && userIndexTwitch < 20) {
					return GetFollowsHelix(false, false);
				}
			});
		}
	});
}

function AfterGetsHelix() {
	for (ii = 0 ; ii < dataStreamsTwitch.data.length ; ii++) {
		for (jj = 0 ; jj < dataFollowsTwitch.data.length ; jj++) {
			if (userObjT.user[jj].id == dataStreamsTwitch.data[ii].user_id && dataStreamsTwitch.data[ii].type == "live" && userIndexTwitch < 20) {
				rowT = document.createElement("div");
				rowT.classList.add("row");
				tableT.appendChild(rowT);
				cellT = document.createElement("div");
				cellT.classList.add("cell");
				rowT.appendChild(cellT);
				pT = document.createElement("p");
				cellT.appendChild(pT);
				spanT = document.createElement("span");
				spanT.setAttribute("id", "helix" + userIndexTwitch); // set element ID
				pT.appendChild(spanT);
				spanT.innerHTML = userObjT.user[jj].login; // display names from twitch IDs
				spanT.style.backgroundColor = "lightgreen"; // change background color of name
				spanT.title = dataStreamsTwitch.data[ii].title;
				spanT.onclick = function(event) { LoadChannel(event.target.innerHTML, "twitch"); }; // create links for fast channel changes
				userIndexTwitch++;
			}
		}
	}
}

function UpdateFollowListHelix() {
	return GetFollowsHelix(true, true);
}

function CreateFollowListMixer() {
	$.ajax({
		type: "GET",
		url: "https://mixer.com/api/v1/channels/" + g_userName,
		headers: { "Client-ID": "07b3b0eaa709e93934f6720d6130f2aa0ec716a93c5033d6" },
		success: function(data, textstatus, jqxhr) {
			//console.log(data);
			dataUserMixer = data;
			GetFollowsMixer(true, false);
		}
	});
}

function GetFollowsMixer(init, destroy) {
	if (init) {
		userIndexMixer = 0;
		hasCountMixer = false;
		pageMixer = 0;
		if (!destroy) {
			tableM = document.createElement("div");
			tableM.classList.add("table");
			tableM.setAttribute("id", "follow-table-mixer");
			document.getElementById("follows-mixer").appendChild(tableM);
		}
	}

	if (destroy) {
		oldTableM = document.getElementById("follow-table-mixer");
		if (oldTableM) oldTableM.parentNode.removeChild(oldTableM);
		tableM = document.createElement("div");
		tableM.classList.add("table");
		tableM.setAttribute("id", "follow-table-mixer");
		document.getElementById("follows-mixer").appendChild(tableM);
	}

	$.ajax({
		type: "GET",
		url: "https://mixer.com/api/v1/users/" + dataUserMixer.user.id + "/follows?limit=100&page=" + pageMixer,
		headers: { "Client-ID": "07b3b0eaa709e93934f6720d6130f2aa0ec716a93c5033d6" },
		success: function(data, textstatus, jqxhr) {
			//console.log(data);
			dataFollowsMixer = data;

			if (!hasCountMixer) {
				countMixer = jqxhr.getResponseHeader("x-total-count");
				countMixer -= dataFollowsMixer.length;
				hasCountMixer = true;
			} else {
				countMixer -= dataFollowsMixer.length;
			}

			pageMixer++;

			for (ii = 0 ; ii < dataFollowsMixer.length ; ii++) {
				if (dataFollowsMixer[ii].online == true) {
					rowM = document.createElement("div");
					rowM.classList.add("row");
					tableM.appendChild(rowM);
					cellM = document.createElement("div");
					cellM.classList.add("cell");
					rowM.appendChild(cellM);
					pM = document.createElement("p");
					cellM.appendChild(pM);
					spanM = document.createElement("span");
					pM.appendChild(spanM);
					spanM.innerHTML = dataFollowsMixer[ii].token; // display names from mixer IDs
					spanM.onclick = function(event) { LoadChannel(event.target.innerHTML, "mixer"); }; // create links for fast channel changes
					spanM.style.backgroundColor = "lightgreen"; // change background color of name
					userIndexMixer++;
				}
			}
		},
		complete: function() {
			if (countMixer > 0 && userIndexMixer < 20) {
				return GetFollowsMixer(false, false);
			}
		}
	});
}

function UpdateFollowListMixer() {
	GetFollowsMixer(true, true);
}
		</script>
	</body>
</html>
